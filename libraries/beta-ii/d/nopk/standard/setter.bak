//      /d/standard/setter.c
//      Starting room for new characters choosing races
//      from the Nightmare Mudlib
//      created by Shadowwolf@Nightmare july 1992
//      modified by Descartes of Borg for the race daemon 10 june 1993

#include <std.h>
#include <rooms.h>
#include <daemons.h>
#include <sindarii.h>
inherit ROOM;

void do_rolls();

void create() {
  ::create();
    set_property("light", 2);
    set_property("indoors", 1);
    set_property("no teleport", 1);
    set("long",
	"You are in a small box of both infinite and no dimensions. "
	"%^BOLD%^%^BLACK%^Reality is black and without material.%^RESET%^ "
        "You are being created. You intuit a list of possible races you "
        "might become, and even read it. Once you pick your race, you can "
        "begin your journey through the reality of %^BOLD%^%^RED%^Carnage%^RESET%^! "
        "\n\nType %^BOLD%^%^CYAN%^<read list> %^RESET%^to see the list of races.\n"
        "\nWhen your ready to pick a race type %^BOLD%^%^CYAN%^<pick %^BLUE%^[race desired]%^CYAN%^>%^RESET%^.");
    skip_obvious();
    set_items(
	(["room" : "The nothingness from which you will be born "
	    "into Carnage.",
	  "list" : "A list of races that exist in the world of Carnage."]) );
}

void init() {
    ::init();
    add_action("read", "read");
    add_action("pick","pick");
    if (this_player()->query_exp() != 0) {
        write("\nWelcome to %^BLUE%^P%^BOLD%^rimal %^RESET%^%^BLUE%^D%^BOLD%^arkness%^RESET%^!\n"
	"Please choose a race for yourself.  Your race determines your main "
	"genetic attributes, strength, intelligence, dexterity, constitution, "
	"and charisma.");
	this_player()->set_rolls(0);
    }
}
int pick(string str) {
    string *which;
    mapping borg;
    int tmp, i;
    string classs;

    classs = "child";
    if(!str) {
        write("To pick a race, type <pick [whatever]>, where whatever is the race.");
        return 1;
    }
    str = lower_case(str);
    if(str == "satyr" &&
      (string)this_player()->query_gender() != "male") {
	write("You must be a male to be a satyr!\nPlease pick again.");
	return 1;
    }
    else if(str == "nymph" && (string)this_player()->query_gender()
      != "female") {
	write("You must be a female to be a nymph!\nPlease pick again.");
	return 1;
    }
    if (str == "dragon" || str == "demon" || str == "god" ||
        str == "lich" || str == "archangel") {
       write("You may not choose that race at creation.");
       return 1;
    }
    if(member_array(str, (string *)RACE_D->query_races()) == -1) {
	write("You must pick a race from the list!\nType <read list>\n");
	return 1;
    }
    this_player()->set_race(str);
    this_player()->new_body();
    this_player()->set_class(classs);
    if( (string)this_player()->query_gender() == "male") this_player()->setenv("TITLE", "Newbie $N the boy");
    else this_player()->setenv("TITLE", "Newbie $N the girl");
    this_player()->init_skills(classs);
    write("You can roll your stats up to three times.");
    write("You do this in the hall of the class you will soon choose.");
    do_rolls();
    write("You awake in a strange place ready to begin your life anew...");
    new(ARM"boots")->move(this_player());
    new(ARM"chainmail")->move(this_player());
    new(ARM"helmet")->move(this_player());
    new(WEP"sword")->move(this_player());
    this_player()->add_hp(this_player()->query_max_hp());
    this_player()->add_sp(this_player()->query_max_sp());
    this_player()->add_mp(this_player()->query_max_mp());
    this_player()->add_money("gold", 600);

    this_player()->move_player(ROOM_START);
    return 1;
}

void do_rolls() {
    string *which;
    mapping borg;
    int i, tmp;

/*    if((int)this_player()->query_rolls() >3) {
        write("You can roll your stats no more.");
        return;
    } */
    write("You roll your stats.");
    for(i=0, tmp=sizeof(which=keys(borg=(mapping)RACE_D->do_rolls((string)this_player()->query("race")))); i<tmp; i++) 
        this_player()->set_stats(which[i], borg[which[i]]);
    this_player()->force_me("stats");
    return;
}

int read(string str) {
    string *res;
    int i, j, tmp;
    if(!str) {
	notify_fail("\nWhat do you want to read? A list?\n");
	return 0;
    }
    if(str != "list") {
	notify_fail("\nThat is not here to be read.\n");
	return 0;
    }
    write("\nThese are the following races available in our reality:");
    write("%^BOLD%^%^CYAN%^-----------------------------------------------------------%^RESET%^");
    message("Ninfo", format_page((string *)RACE_D->query_races(), 4),
      this_player());
    write("%^BOLD%^%^CYAN%^----------------------------------------------------------%^RESET%^");

    write("Only males may be satyrs, and only females may be nymphs.");
    write("pick %^BOLD%^%^CYAN%^<race>%^RESET%^ will forever make you one "
          "of these races. Type %^BOLD%^%^CYAN%^<help races>%^RESET%^ for "
          "more information. Type %^BOLD%^%^CYAN%^<ansi on>%^RESET%^ to "
          "view a world of colors!\n");
    write("%^BOLD%^%^CYAN%^Note:%^RESET%^ Some races, such as dragon, "
      "demon and archangel may not be chosen at creation. Type %^BOLD%^%^CYAN%^help <racename>%^RESET%^ for more information. Remember to replace <racename> with the race you wish to have help on.");
    return 1;
}
